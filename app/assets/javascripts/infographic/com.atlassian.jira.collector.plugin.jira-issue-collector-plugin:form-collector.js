/* module-key = 'com.atlassian.jira.collector.plugin.jira-issue-collector-plugin:form-collector', location = '/js/collector/collector.js' */
AJS.$(function(){var j=AJS.$(".collector-dialog form#jic-collector-form");var i={};var f={};var c=AJS.$(".custom-collector");c.addClass("visuallyhidden");var g=function(){var k=AJS.$('<div class="msg-container shadowed"></div>');AJS.messages.error(k,{title:"Oops! Something went wrong...",body:"<p>"+"Don\'t worry though! We\'ve logged this problem and will look into it soon!"+"</p>",closeable:false});j.prepend(k)};var d=function(l){if(l.errors!==undefined&&l.errors!=={}){var k=false;AJS.$.each(l.errors,function(o,n){var m=f[o]||j.find("#"+o).closest(".field-group,form");if(m==="undefined"||m.length===0){k=true}m.append('<div class="error">'+n+"</div>")});if(k){g()}else{j.removeClass("disabled").find(".submit-button").removeAttr("disabled")}}else{g()}};var h=function(k,l){j.find("#"+k).after('<div class="error">'+l+"</div>")};var e=function(){if(!AJS.$.isEmptyObject(i)){for(var k in i){if(!i.hasOwnProperty(k)){continue}var l=i[k];var o=k.replace(/(:|\.)/g,"\\$1");var n=j.find("#"+o).add(j.find('input[type="radio"],input[type="checkbox"]').filter('[name="'+k+'"]'));if(n.length!=0){n.val(i[k])}else{var m=function(p,q){AJS.$('<input type="hidden">').attr("name",k).val(q).appendTo(j)};if(AJS.$.isArray(l)){AJS.$.each(l,m)}else{m(undefined,l)}}}}};var b=function(){if(AJS.$(".dont-default-focus").size()===0){AJS.$(window).focus();AJS.$("input.text:visible, textarea.textarea:visible").first().focus()}};j.ajaxForm({skipEncodingOverride:true,dataType:"json",beforeSubmit:function(m,s,r){s.find(".error").remove();if(!AJS.params.customTemplate){var p=s.find("#description"),q=s.find("input[name=rating]");if(q.length>0){var t=true;var l=s.find("input[name=rating]:checked").val();if(!l||l.length==0){h("feedback-rating","Please rate this page.");t=false}var k=AJS.$.trim(s.find("#description-good").val());if(!k||k.length==0){h("description-good","Please provide an answer for: What do you like?");t=false}var o=AJS.$.trim(s.find("#description-bad").val());if(!o||o.length==0){h("description-bad","Please provide an answer for: What needs to be improved?");t=false}if(!t){return false}}if(p.length===1){var n=AJS.$.trim(p.val());if(!n||n.length==0){h("description","Please provide an answer for: What went wrong?");return false}}}s.addClass("disabled").find(".submit-button").attr("disabled","disabled");return true},success:function(n,l,p,m){var o=AJS.$('<div class="msg-container"></div>');var k;if(n.errors!==undefined){d(n);return}if(n.url!==undefined){var q='<a class="issue-key" target="_blank" href="'+n.url+'">'+n.key+"</a>";k="<p>"+AJS.format("Your feedback has been recorded in {0}. This window will automatically close in 5 seconds.",q)+"</p>"}else{k="<p>"+"Thanks for providing your feedback! This window will automatically close in 5 seconds."+"</p>"}AJS.messages.success(o,{title:"Thank you for your feedback!",body:k,closeable:false});m.prepend(o);setTimeout(function(){window.top.postMessage("cancelFeedbackDialog","*")},5000)},error:function(l,k,m){d(l.status===400?JSON.parse(l.responseText):{})}});var a=function(k){k.preventDefault();window.top.postMessage("cancelFeedbackDialog","*")};AJS.$(window).keydown(function(k){if(k.keyCode===27){a(k)}});AJS.$(".dialog-button-panel .cancel").click(function(k){a(k)});AJS.$(".aui-message.custom-msg a").each(function(){AJS.$(this).attr("target","_blank")});AJS.$("#not-you-lnk").click(function(k){k.preventDefault();AJS.$("#name-group").show();AJS.$("#email-group").show();AJS.$(".login-msg").hide()});AJS.InlineAttach.Renderers.container=function(){return AJS.$("<div class='checkbox'/>")};AJS.InlineAttach.AjaxPresenter.DEFAULT_URL="/rest/collectors/1.0/tempattachment/"+AJS.params.collectorId;AJS.InlineAttach.FormPresenter.DEFAULT_URL="/rest/collectors/1.0/tempattachment/multipart/"+AJS.params.collectorId;AJS.$(window).bind("message",function(m){try{var l=JSON.parse(m.originalEvent.data);AJS.$("#webInfo").val(l.feedbackString);i=l.fieldValues}catch(k){}if(AJS.params.customTemplate){AJS.$.ajax({url:"/secure/CreateFields!default.jspa?decorator=none&projectKey="+AJS.params.projectKey+"&issueType="+AJS.params.issueType,contentType:"application/json",success:function(p){var s=AJS.$(".custom-fields-container");var o={};var r={};var q=function(x,w){var u=(w instanceof AJS.$)?w:AJS.$(w);var t,v;if(r[x]){t=u.children("label, legend").first();if(t.is("legend")){t=t.find("span")}v=t.contents().first();v.replaceWith(document.createTextNode(r[x]))}};if(AJS.params.customLabels){r=JSON.parse(AJS.params.customLabels)}AJS.$(p.fields).each(function(t,u){o[u.id]=u});AJS.$(".contact-form-fields").each(function(t,u){q(u.id,u)});AJS.$(JSON.parse(AJS.params.fields)).each(function(t,w){if(o[w]){var v=AJS.$(o[w].editHtml);q(w,v);v=v.appendTo(s);function u(x){var z=x.filter(".field-group,fieldset.group");if(z.length>0){return z.last()}z=x.find(".field-group,fieldset.group");if(z.length>0){return z.last()}var y=x.filter(":has(input)");if(y.length>0){return y.last()}return s}f[w]=u(v)}});e();var n={get$popupContent:function(){return s}};AJS.InlineAttach.AjaxPresenter.DEFAULT_URL="/rest/collectors/1.0/tempattachment/"+AJS.params.collectorId;AJS.InlineAttach.FormPresenter.DEFAULT_URL="/rest/collectors/1.0/tempattachment/multipart/"+AJS.params.collectorId;AJS.$(document).trigger("dialogContentReady",[n]);c.removeClass("visuallyhidden");b()},error:function(n){c.removeClass("visuallyhidden");d(n)}})}else{e();b()}})});
